<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador ESP32 - SmartBee (Actualizado)</title>
    <script src="https://unpkg.com/mqtt@4.3.7/dist/mqtt.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .config-section {
            background: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .config-section h3 {
            margin-top: 0;
            color: #34495e;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            box-sizing: border-box;
        }
        button {
            background: #3498db;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #2980b9;
        }
        button:disabled {
            background: #95a5a6;
            cursor: not-allowed;
        }
        button.danger {
            background: #e74c3c;
        }
        button.danger:hover {
            background: #c0392b;
        }
        button.success {
            background: #27ae60;
        }
        button.success:hover {
            background: #219a52;
        }
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.connected {
            background: #d5f4e6;
            color: #27ae60;
            border: 1px solid #27ae60;
        }
        .status.disconnected {
            background: #fadbd8;
            color: #e74c3c;
            border: 1px solid #e74c3c;
        }
        .status.connecting {
            background: #fef9e7;
            color: #f39c12;
            border: 1px solid #f39c12;
        }
        .sensor-data {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .sensor-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
        }
        .sensor-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }
        .log {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            margin-top: 20px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-entry.error {
            color: #e74c3c;
        }
        .log-entry.success {
            color: #27ae60;
        }
        .log-entry.info {
            color: #3498db;
        }
        .log-entry.warning {
            color: #f39c12;
        }
        .test-section {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #27ae60;
        }
        .alert-section {
            background: #fff3cd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 2px solid #ffc107;
        }
        .nodo-info {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 14px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .stat-item {
            background: #fff;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            border: 1px solid #ddd;
        }
        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
        }
        .scenario-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêù Simulador ESP32 - SmartBee (v2.0)</h1>
        
        <!-- Test de conectividad -->
        <div class="test-section">
            <h3>üß™ Test de Conectividad y Configuraci√≥n</h3>
            <p><strong>Base de datos:</strong> crossover.proxy.rlwy.net:19862</p>
            <p><strong>Broker MQTT:</strong> broker.emqx.io:1883</p>
            <p><strong>T√≥pico:</strong> testtopic/smartbee</p>
            <button onclick="testMQTTConnection()">üîç Test MQTT</button>
            <button onclick="generateTestMessage()">üìù Generar Mensaje Test</button>
            <button onclick="testBackendConnection()">üîß Test Backend Local</button>
        </div>

        <!-- Configuraci√≥n del Nodo -->
        <div class="config-section">
            <h3>üì° Configuraci√≥n del Nodo</h3>
            <div class="form-group">
                <label for="nodoId">Seleccionar Nodo:</label>
                <select id="nodoId" onchange="updateNodoInfo()">
                    <!-- Nodos de COLMENA con peso -->
                    <option value="NODO-7881883A-97A5-47E0-869C-753E99E1B168">üè† COLMENA - Interior (Con peso)</option>
                    <option value="NODO-BEF8C985-0FF3-4874-935B-40AA8A235FF7">üè† COLMENA - Interior (Con peso)</option>
                    
                    <!-- Nodos AMBIENTALES sin peso -->
                    <option value="NODO-B5B3ABC4-E0CE-4662-ACB3-7A631C12394A">üå°Ô∏è AMBIENTAL - Exterior</option>
                    <option value="NODO-38999D61-E214-4870-8352-2E0C2BD603DC">üå°Ô∏è AMBIENTAL - Exterior</option>
                    <option value="NODO-D0DAF85F-4F13-4FE9-9406-A3B3ECF5AAF8">üå°Ô∏è AMBIENTAL - Exterior</option>
                    
                    <!-- Nodo personalizado -->
                    <option value="custom">‚úèÔ∏è Personalizado...</option>
                </select>
            </div>
            <div class="form-group" id="customNodoGroup" style="display: none;">
                <label for="customNodoId">ID del Nodo Personalizado:</label>
                <input type="text" id="customNodoId" placeholder="NODO-XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX">
            </div>
            <div id="nodoInfo" class="nodo-info">
                <strong>Tipo:</strong> <span id="nodoTipo">COLMENA</span><br>
                <strong>Ubicaci√≥n:</strong> <span id="nodoUbicacion">Interior de colmena</span><br>
                <strong>Sensores:</strong> <span id="nodoSensores">Temperatura, Humedad, Peso</span>
            </div>
        </div>

        <!-- Estado de conexi√≥n -->
        <div id="connectionStatus" class="status disconnected">
            üî¥ Desconectado de MQTT
        </div>

        <!-- Controles principales -->
        <div>
            <button id="connectBtn" onclick="connectMQTT()">üîå Conectar MQTT</button>
            <button id="disconnectBtn" onclick="disconnectMQTT()" disabled>‚ùå Desconectar</button>
            <button id="sendBtn" onclick="sendSensorData()" disabled>üì§ Enviar Datos</button>
            <button id="autoBtn" onclick="toggleAutoSend()" disabled>‚è±Ô∏è Auto (10s)</button>
            <button onclick="clearLog()" class="danger">üßπ Limpiar Log</button>
        </div>

        <!-- Escenarios predefinidos para testing de alertas -->
        <div class="alert-section">
            <h3>‚ö†Ô∏è Escenarios de Testing para Alertas</h3>
            <p>Simula condiciones que activan alertas espec√≠ficas:</p>
            <div class="scenario-buttons">
                <button onclick="setScenario('temp_critica')" class="danger">üî• Temp Cr√≠tica (>38¬∞C)</button>
                <button onclick="setScenario('temp_alta')" class="warning">üå°Ô∏è Temp Alta (36-37¬∞C)</button>
                <button onclick="setScenario('hum_critica_invierno')" class="danger">üíß Humedad Cr√≠tica (>70%)</button>
                <button onclick="setScenario('hum_baja_verano')" class="warning">üèúÔ∏è Humedad Baja (<40%)</button>
                <button onclick="setScenario('peso_enjambre')" class="warning">üêù P√©rdida Peso Enjambre</button>
                <button onclick="setScenario('normal')" class="success">‚úÖ Condiciones Normales</button>
                <button onclick="setScenario('extreme')" class="danger">üö® Condiciones Extremas</button>
            </div>
        </div>

        <!-- Datos del sensor -->
        <div class="config-section">
            <h3>üìä Datos del Sensor</h3>
            <div class="sensor-data">
                <div class="sensor-item">
                    <label>üå°Ô∏è Temperatura (¬∞C):</label>
                    <div class="sensor-value" id="tempValue">25.0</div>
                    <input type="range" id="tempSlider" min="-5" max="45" value="25" step="0.1" onchange="updateTemp(this.value)">
                    <small>Rango: -5¬∞C a 45¬∞C</small>
                </div>
                <div class="sensor-item">
                    <label>üíß Humedad (%):</label>
                    <div class="sensor-value" id="humValue">65.0</div>
                    <input type="range" id="humSlider" min="0" max="100" value="65" step="0.1" onchange="updateHum(this.value)">
                    <small>Rango: 0% a 100%</small>
                </div>
                <div class="sensor-item" id="pesoContainer">
                    <label>‚öñÔ∏è Peso (kg):</label>
                    <div class="sensor-value" id="pesoValue">22.0</div>
                    <input type="range" id="pesoSlider" min="10" max="80" value="22" step="0.1" onchange="updatePeso(this.value)">
                    <small>Rango: 10kg a 80kg</small>
                </div>
            </div>
            <div style="margin: 15px 0;">
                <label><input type="checkbox" id="randomData"> üé≤ Variaci√≥n aleatoria (¬±2¬∞C, ¬±5%, ¬±0.5kg)</label>
                <label><input type="checkbox" id="includeTimestamp" checked> ‚è∞ Incluir timestamp</label>
                <label><input type="checkbox" id="simulateAlerts"> ‚ö†Ô∏è Modo simulaci√≥n de alertas</label>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="config-section">
            <h3>üìà Estad√≠sticas de Env√≠o</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="messageCount">0</div>
                    <div>Mensajes Enviados</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="errorCount">0</div>
                    <div>Errores</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="uptime">00:00:00</div>
                    <div>Tiempo Activo</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="avgInterval">-</div>
                    <div>Intervalo Promedio</div>
                </div>
            </div>
        </div>

        <!-- Log -->
        <div class="log" id="logContainer">
            <div class="log-entry info">[INFO] Simulador ESP32 v2.0 iniciado</div>
            <div class="log-entry info">[INFO] Configurado para Railway DB + broker.emqx.io</div>
            <div class="log-entry info">[INFO] Soporte para alertas integrado</div>
            <div class="log-entry info">[INFO] Selecciona un nodo y haz clic en 'Conectar MQTT'</div>
        </div>
    </div>

    <script>
        let client = null;
        let isConnected = false;
        let autoSendInterval = null;
        let messageCount = 0;
        let errorCount = 0;
        let startTime = null;
        let lastMessageTime = null;

        // Configuraci√≥n actualizada
        const config = {
            mqtt: {
                broker: "broker.emqx.io",
                port: 8083,
                topic: "testtopic/smartbee"
            },
            backend: {
                url: "http://localhost:8080/api"
            }
        };

        // Informaci√≥n de nodos actualizada
        const nodosInfo = {
            'NODO-7881883A-97A5-47E0-869C-753E99E1B168': {
                tipo: 'COLMENA',
                ubicacion: 'Interior de colmena',
                sensores: 'Temperatura, Humedad, Peso',
                tienePeso: true
            },
            'NODO-BEF8C985-0FF3-4874-935B-40AA8A235FF7': {
                tipo: 'COLMENA', 
                ubicacion: 'Interior de colmena',
                sensores: 'Temperatura, Humedad, Peso',
                tienePeso: true
            },
            'NODO-B5B3ABC4-E0CE-4662-ACB3-7A631C12394A': {
                tipo: 'AMBIENTAL',
                ubicacion: 'Exterior (ambiente)',
                sensores: 'Temperatura, Humedad',
                tienePeso: false
            },
            'NODO-38999D61-E214-4870-8352-2E0C2BD603DC': {
                tipo: 'AMBIENTAL',
                ubicacion: 'Exterior (ambiente)', 
                sensores: 'Temperatura, Humedad',
                tienePeso: false
            },
            'NODO-D0DAF85F-4F13-4FE9-9406-A3B3ECF5AAF8': {
                tipo: 'AMBIENTAL',
                ubicacion: 'Exterior (ambiente)',
                sensores: 'Temperatura, Humedad', 
                tienePeso: false
            }
        };

        // Escenarios predefinidos para testing
        const scenarios = {
            normal: {
                temp: { min: 20, max: 28 },
                hum: { min: 50, max: 70 },
                peso: { min: 20, max: 25 },
                description: "Condiciones normales de operaci√≥n"
            },
            temp_critica: {
                temp: { min: 38.5, max: 42 },
                hum: { min: 45, max: 65 },
                peso: { min: 20, max: 25 },
                description: "Temperatura cr√≠tica alta (>38¬∞C) - Dispara ALERT001"
            },
            temp_alta: {
                temp: { min: 36, max: 37 },
                hum: { min: 50, max: 70 },
                peso: { min: 20, max: 25 },
                description: "Temperatura alta preventiva (36-37¬∞C) - Dispara ALERT002"
            },
            hum_critica_invierno: {
                temp: { min: 15, max: 20 },
                hum: { min: 71, max: 85 },
                peso: { min: 20, max: 25 },
                description: "Humedad cr√≠tica en invierno (>70%) - Dispara ALERT007"
            },
            hum_baja_verano: {
                temp: { min: 25, max: 32 },
                hum: { min: 25, max: 39 },
                peso: { min: 20, max: 25 },
                description: "Humedad baja en verano (<40%) - Dispara ALERT009"
            },
            peso_enjambre: {
                temp: { min: 22, max: 28 },
                hum: { min: 55, max: 70 },
                peso: { min: 19, max: 21 }, // Peso reducido para simular enjambre
                description: "P√©rdida de peso por enjambre - Dispara ALERT011"
            },
            extreme: {
                temp: { min: 40, max: 44 },
                hum: { min: 80, max: 95 },
                peso: { min: 15, max: 18 },
                description: "Condiciones extremas m√∫ltiples - Dispara varias alertas"
            }
        };

        function updateNodoInfo() {
            const nodoSelect = document.getElementById('nodoId');
            const customGroup = document.getElementById('customNodoGroup');
            
            if (nodoSelect.value === 'custom') {
                customGroup.style.display = 'block';
                updateNodoInfoDisplay('CUSTOM', 'Personalizado', 'Definido por usuario', false);
            } else {
                customGroup.style.display = 'none';
                const nodoInfo = nodosInfo[nodoSelect.value];
                if (nodoInfo) {
                    updateNodoInfoDisplay(nodoInfo.tipo, nodoInfo.ubicacion, nodoInfo.sensores, nodoInfo.tienePeso);
                }
            }
            updatePesoVisibility();
        }

        function updateNodoInfoDisplay(tipo, ubicacion, sensores, tienePeso) {
            document.getElementById('nodoTipo').textContent = tipo;
            document.getElementById('nodoUbicacion').textContent = ubicacion;
            document.getElementById('nodoSensores').textContent = sensores;
        }

        function getCurrentNodoId() {
            const select = document.getElementById('nodoId');
            if (select.value === 'custom') {
                return document.getElementById('customNodoId').value.trim();
            }
            return select.value;
        }

        function updatePesoVisibility() {
            const nodoId = getCurrentNodoId();
            const nodoInfo = nodosInfo[nodoId];
            const pesoContainer = document.getElementById('pesoContainer');
            
            if (nodoInfo && nodoInfo.tienePeso) {
                pesoContainer.style.display = 'block';
            } else {
                pesoContainer.style.display = 'none';
            }
        }

        function setScenario(scenarioName) {
            const scenario = scenarios[scenarioName];
            if (!scenario) return;

            const temp = (Math.random() * (scenario.temp.max - scenario.temp.min) + scenario.temp.min).toFixed(1);
            const hum = (Math.random() * (scenario.hum.max - scenario.hum.min) + scenario.hum.min).toFixed(1);
            const peso = (Math.random() * (scenario.peso.max - scenario.peso.min) + scenario.peso.min).toFixed(1);

            document.getElementById('tempSlider').value = temp;
            document.getElementById('humSlider').value = hum;
            document.getElementById('pesoSlider').value = peso;

            updateTemp(temp);
            updateHum(hum);
            updatePeso(peso);

            addLog(`üé≠ Escenario aplicado: ${scenarioName}`, 'warning');
            addLog(`üìã ${scenario.description}`, 'info');
        }

        function testBackendConnection() {
            addLog('üîß Probando conexi√≥n con backend local...', 'info');
            
            fetch(`${config.backend.url}/health`)
                .then(response => response.json())
                .then(data => {
                    addLog('‚úÖ Backend local conectado exitosamente', 'success');
                    addLog(`üìä Respuesta: ${data.message}`, 'info');
                })
                .catch(error => {
                    addLog('‚ùå Backend local no disponible', 'error');
                    addLog(`üí° Aseg√∫rate de ejecutar: npm run backend:app`, 'warning');
                    addLog(`üîó URL esperada: ${config.backend.url}`, 'info');
                });
        }

        function checkMQTTLibrary() {
            if (typeof mqtt === 'undefined') {
                addLog('‚ùå Error: Librer√≠a MQTT no disponible', 'error');
                addLog('üí° Recargar p√°gina para intentar nuevamente', 'info');
                return false;
            }
            addLog('‚úÖ Librer√≠a MQTT cargada correctamente', 'success');
            return true;
        }

        function testMQTTConnection() {
            addLog('üß™ Iniciando test de conectividad MQTT...', 'info');
            
            if (!checkMQTTLibrary()) {
                return;
            }

            addLog(`üîç Configuraci√≥n MQTT:`, 'info');
            addLog(`   Broker: ${config.mqtt.broker}`, 'info');
            addLog(`   Puerto WebSocket: ${config.mqtt.port}`, 'info');
            addLog(`   T√≥pico: ${config.mqtt.topic}`, 'info');
            addLog(`   Protocolo: WebSocket sin autenticaci√≥n`, 'info');

            const nodoId = getCurrentNodoId();
            if (!nodoId) {
                addLog('‚ùå Selecciona un nodo v√°lido', 'error');
                return;
            }
            addLog(`   Nodo seleccionado: ${nodoId}`, 'info');
        }

        function generateTestMessage() {
            const data = generateSensorData();
            const message = JSON.stringify(data, null, 2);

            addLog('üìù Mensaje de prueba generado:', 'success');
            addLog(`üìç T√≥pico: ${config.mqtt.topic}`, 'info');
            addLog(`üì¶ Payload:`, 'info');
            addLog(message, 'info');
            addLog('üí° Listo para env√≠o por MQTT', 'info');
        }

        function updateTemp(value) {
            document.getElementById('tempValue').textContent = parseFloat(value).toFixed(1);
        }

        function updateHum(value) {
            document.getElementById('humValue').textContent = parseFloat(value).toFixed(1);
        }

        function updatePeso(value) {
            document.getElementById('pesoValue').textContent = parseFloat(value).toFixed(1);
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;

            // Limitar n√∫mero de entradas en el log
            if (logContainer.children.length > 200) {
                logContainer.removeChild(logContainer.firstChild);
            }
        }

        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
            addLog('Log limpiado', 'info');
        }

        function updateConnectionStatus(status, message) {
            const statusEl = document.getElementById('connectionStatus');
            statusEl.className = `status ${status}`;
            statusEl.textContent = message;
        }

        function updateStats() {
            document.getElementById('messageCount').textContent = messageCount;
            document.getElementById('errorCount').textContent = errorCount;
            
            if (startTime) {
                const uptime = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(uptime / 3600);
                const minutes = Math.floor((uptime % 3600) / 60);
                const seconds = uptime % 60;
                document.getElementById('uptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }

            if (messageCount > 1 && lastMessageTime) {
                const avgInterval = Math.floor((Date.now() - startTime) / messageCount / 1000);
                document.getElementById('avgInterval').textContent = `${avgInterval}s`;
            }
        }

        function connectMQTT() {
            if (!checkMQTTLibrary()) {
                return;
            }

            const nodoId = getCurrentNodoId();
            if (!nodoId) {
                addLog('‚ùå Selecciona un nodo v√°lido', 'error');
                return;
            }

            addLog(`üîå Conectando a ws://${config.mqtt.broker}:${config.mqtt.port}`, 'info');
            updateConnectionStatus('connecting', 'üü° Conectando a MQTT...');

            try {
                const clientId = 'ESP32_SIM_' + Math.random().toString(16).substr(2, 8);
                const url = `ws://${config.mqtt.broker}:${config.mqtt.port}/mqtt`;
                
                const options = {
                    clientId: clientId,
                    clean: true,
                    connectTimeout: 10000,
                    keepalive: 60,
                    reconnectPeriod: 1000
                };

                client = mqtt.connect(url, options);

                client.on('connect', onConnect);
                client.on('error', onConnectFailure);
                client.on('close', onConnectionLost);
                client.on('reconnect', () => {
                    addLog('üîÑ Reconectando...', 'warning');
                });

            } catch (error) {
                addLog(`‚ùå Error creando cliente: ${error.message}`, 'error');
                updateConnectionStatus('disconnected', 'üî¥ Error de conexi√≥n');
                errorCount++;
                updateStats();
            }
        }

        function onConnect() {
            isConnected = true;
            startTime = Date.now();
            addLog('‚úÖ Conectado a broker.emqx.io exitosamente', 'success');
            updateConnectionStatus('connected', 'üü¢ Conectado a MQTT');
            
            document.getElementById('connectBtn').disabled = true;
            document.getElementById('disconnectBtn').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('autoBtn').disabled = false;

            updatePesoVisibility();
        }

        function onConnectFailure(error) {
            addLog(`‚ùå Error de conexi√≥n: ${error.message || error}`, 'error');
            updateConnectionStatus('disconnected', 'üî¥ Error de conexi√≥n');
            errorCount++;
            updateStats();
            
            addLog('üîß Posibles soluciones:', 'info');
            addLog('1. Verificar conectividad a internet', 'info');
            addLog('2. Firewall puede estar bloqueando WebSocket', 'info');
            addLog('3. Probar con MQTT Explorer desde PC', 'info');
        }

        function onConnectionLost() {
            addLog('‚ùå Conexi√≥n perdida', 'error');
            updateConnectionStatus('disconnected', 'üî¥ Conexi√≥n perdida');
            isConnected = false;
            
            document.getElementById('connectBtn').disabled = false;
            document.getElementById('disconnectBtn').disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('autoBtn').disabled = true;
            
            if (autoSendInterval) {
                clearInterval(autoSendInterval);
                autoSendInterval = null;
                document.getElementById('autoBtn').textContent = '‚è±Ô∏è Auto (10s)';
            }
        }

        function disconnectMQTT() {
            if (client && isConnected) {
                client.end();
                addLog('üîå Desconectado de MQTT', 'info');
                updateConnectionStatus('disconnected', 'üî¥ Desconectado');
                
                isConnected = false;
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                document.getElementById('sendBtn').disabled = true;
                document.getElementById('autoBtn').disabled = true;
                
                if (autoSendInterval) {
                    clearInterval(autoSendInterval);
                    autoSendInterval = null;
                    document.getElementById('autoBtn').textContent = '‚è±Ô∏è Auto (10s)';
                }
            }
        }

        function generateSensorData() {
            const randomData = document.getElementById('randomData').checked;
            const includeTimestamp = document.getElementById('includeTimestamp').checked;
            const simulateAlerts = document.getElementById('simulateAlerts').checked;
            const nodoId = getCurrentNodoId();
            
            if (!nodoId) {
                addLog('‚ùå ID de nodo no v√°lido', 'error');
                return null;
            }

            const nodoInfo = nodosInfo[nodoId];
            const isColmena = nodoInfo ? nodoInfo.tienePeso : nodoId.includes('COLMENA');

            let temperatura, humedad, peso;

            if (randomData) {
                // Aplicar variaci√≥n aleatoria a los valores actuales
                const baseTemp = parseFloat(document.getElementById('tempValue').textContent);
                const baseHum = parseFloat(document.getElementById('humValue').textContent);
                const basePeso = parseFloat(document.getElementById('pesoValue').textContent);

                temperatura = (baseTemp + (Math.random() - 0.5) * 4).toFixed(1); // ¬±2¬∞C
                humedad = Math.max(0, Math.min(100, baseHum + (Math.random() - 0.5) * 10)).toFixed(1); // ¬±5%
                
                if (isColmena) {
                    peso = Math.max(10, basePeso + (Math.random() - 0.5) * 1).toFixed(1); // ¬±0.5kg
                }
            } else {
                temperatura = document.getElementById('tempValue').textContent;
                humedad = document.getElementById('humValue').textContent;
                if (isColmena) {
                    peso = document.getElementById('pesoValue').textContent;
                }
            }

            const data = {
                nodo_id: nodoId,
                temperatura: parseFloat(temperatura),
                humedad: parseFloat(humedad)
            };

            if (isColmena && peso !== undefined) {
                data.peso = parseFloat(peso);
            }

            if (includeTimestamp) {
                data.timestamp = new Date().toISOString();
            }

            // Actualizar sliders con los valores generados
            if (randomData) {
                document.getElementById('tempSlider').value = temperatura;
                document.getElementById('humSlider').value = humedad;
                updateTemp(temperatura);
                updateHum(humedad);
                
                if (isColmena && peso !== undefined) {
                    document.getElementById('pesoSlider').value = peso;
                    updatePeso(peso);
                }
            }

            return data;
        }

        function sendSensorData() {
            if (!isConnected) {
                addLog('‚ùå No hay conexi√≥n MQTT', 'error');
                return;
            }

            const data = generateSensorData();
            if (!data) {
                return;
            }

            const message = JSON.stringify(data);

            try {
                client.publish(config.mqtt.topic, message, { qos: 1 }, (error) => {
                    if (error) {
                        addLog(`‚ùå Error enviando mensaje: ${error.message}`, 'error');
                        errorCount++;
                    } else {
                        messageCount++;
                        lastMessageTime = Date.now();
                        addLog(`üì§ Mensaje #${messageCount} enviado exitosamente`, 'success');
                        addLog(`üìç T√≥pico: ${config.mqtt.topic}`, 'info');
                        addLog(`üì¶ ${JSON.stringify(data)}`, 'info');
                        
                        // Detectar posibles alertas que se activar√≠an
                        detectPossibleAlerts(data);
                    }
                    updateStats();
                });
            } catch (error) {
                addLog(`‚ùå Error enviando mensaje: ${error.message}`, 'error');
                errorCount++;
                updateStats();
            }
        }

        function detectPossibleAlerts(data) {
            const alerts = [];
            const temp = data.temperatura;
            const hum = data.humedad;
            const peso = data.peso;

            // Detectar alertas de temperatura
            if (temp > 38) {
                alerts.push('ALERT001 - Temperatura Cr√≠tica Alta (>38¬∞C)');
            } else if (temp >= 36 && temp <= 37) {
                alerts.push('ALERT002 - Temperatura Alta Preventiva (36-37¬∞C)');
            } else if (temp < 12) {
                alerts.push('ALERT003/006 - Temperatura Baja Cr√≠tica (<12¬∞C)');
            }

            // Detectar alertas de humedad (depende de la √©poca)
            const month = new Date().getMonth() + 1;
            const isInvierno = month >= 3 && month <= 7;
            
            if (isInvierno) {
                if (hum > 70) {
                    alerts.push('ALERT007 - Humedad Cr√≠tica Invierno (>70%)');
                } else if (hum > 60) {
                    alerts.push('ALERT008 - Humedad Alta Preventiva Invierno (>60%)');
                }
            } else {
                if (hum < 40) {
                    alerts.push('ALERT009 - Humedad Baja Cr√≠tica Verano (<40%)');
                } else if (hum < 50) {
                    alerts.push('ALERT010 - Humedad Baja Preventiva Verano (<50%)');
                }
            }

            // Detectar alertas de peso (solo para colmenas)
            if (peso !== undefined) {
                if (peso < 19) {
                    alerts.push('ALERT011 - Posible Enjambre (Peso bajo)');
                } else if (peso > 40) {
                    alerts.push('ALERT012 - Incremento de Peso Significativo');
                }
            }

            if (alerts.length > 0) {
                addLog(`‚ö†Ô∏è Posibles alertas que se activar√≠an:`, 'warning');
                alerts.forEach(alert => {
                    addLog(`   ${alert}`, 'warning');
                });
            }
        }

        function toggleAutoSend() {
            if (autoSendInterval) {
                clearInterval(autoSendInterval);
                autoSendInterval = null;
                document.getElementById('autoBtn').textContent = '‚è±Ô∏è Auto (10s)';
                addLog('üõë Env√≠o autom√°tico detenido', 'info');
            } else {
                autoSendInterval = setInterval(sendSensorData, 10000); // Cada 10 segundos
                document.getElementById('autoBtn').textContent = '‚èπÔ∏è Detener Auto';
                addLog('üîÑ Env√≠o autom√°tico iniciado (cada 10 segundos)', 'success');
            }
        }

        // Actualizar estad√≠sticas cada segundo
        setInterval(updateStats, 1000);

        // Inicializar
        document.getElementById('nodoId').addEventListener('change', updateNodoInfo);
        updateNodoInfo();
        
        // Verificar librer√≠a al cargar
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkMQTTLibrary();
                testBackendConnection();
            }, 1000);
        });

        // Agregar algunos valores predeterminados seg√∫n √©poca del a√±o
        window.addEventListener('load', () => {
            const month = new Date().getMonth() + 1;
            const isInvierno = month >= 3 && month <= 7;
            
            if (isInvierno) {
                addLog('‚ùÑÔ∏è √âpoca detectada: Invernada (Marzo-Julio)', 'info');
                addLog('‚ö†Ô∏è Alertas activas: Temperatura baja, Humedad alta', 'info');
            } else {
                addLog('üåû √âpoca detectada: Primavera-Verano (Agosto-Febrero)', 'info');
                addLog('‚ö†Ô∏è Alertas activas: Temperatura alta, Humedad baja, Enjambraz√≥n', 'info');
            }
        });
    </script>
</body>
</html>